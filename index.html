<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Pyramid Counter ‚Äî Polished + Achievements</title>
<style>
  :root{
    --card-w:420px;
    --bg-1:#07090c; --bg-2:#05111a;
    --muted:#9fa6ad;
    --accent-a:#0b84ff; --accent-b:#2aa0ff;
    --outline:rgba(255,255,255,0.06);
    --glass:rgba(255,255,255,0.02);
    --input-bg: rgba(255,255,255,0.03);
    --input-border: rgba(255,255,255,0.08);
    --ring-w:4;
    --btn-size:150px;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;color:#eef2f3;-webkit-font-smoothing:antialiased}
  .center{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:env(safe-area-inset-top) 14px 14px;box-sizing:border-box;}
  .card{width:100%;max-width:var(--card-w);border-radius:16px;padding:10px 12px 18px;box-sizing:border-box;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));border:1px solid var(--outline);box-shadow:0 18px 50px rgba(0,0,0,0.65);position:relative;}

  /* Top bar */
  .topbar{display:flex;align-items:center;justify-content:space-between;padding:6px 4px;}
  .icons-left, .icons-right{display:flex;gap:8px;align-items:center;min-width:110px}
  .icons-left{justify-content:flex-start}
  .icons-center{flex:1;display:flex;justify-content:center}
  .icons-right{justify-content:flex-end}
  .icon{width:36px;height:36px;border-radius:50%;display:grid;place-items:center;border:1px solid var(--outline);background:rgba(255,255,255,0.02);cursor:pointer;font-size:16px;box-shadow:0 6px 14px rgba(0,0,0,0.45);transition:transform 120ms, background 120ms}
  .icon:active{transform:translateY(2px) scale(.98);}

  /* Inputs */
  .inputs-row{display:flex;align-items:center;gap:12px;padding:6px 6px 10px;justify-content:center;flex-wrap:wrap;}
  .input-col{display:flex;flex-direction:column;gap:6px;align-items:center}
  .input-label{font-size:13px;color:var(--muted);letter-spacing:0.2px;text-align:center}
  input[type=number], select{padding:9px 10px;border-radius:10px;border:1px solid var(--input-border);background:var(--input-bg);color:#fff;font-size:15px;box-shadow:inset 0 4px 10px rgba(0,0,0,0.45)}
  #maxInput{ width:56px; text-align:center; font-weight:700; letter-spacing:0.6px; }

  /* Main area */
  .main{display:flex;gap:10px;align-items:center;justify-content:center;margin-top:4px;margin-bottom:4px;flex-direction:column}
  .btn-area{position:relative; width:calc(var(--btn-size) + 60px); height:calc(var(--btn-size) + 60px); display:flex;align-items:center;justify-content:center;margin-top:6px;}
  .ring-svg{position:absolute;width:calc(var(--btn-size) + 40px);height:calc(var(--btn-size) + 40px);left:50%;top:50%;transform:translate(-50%,-50%);pointer-events:none}
  .ring-svg circle{transition:stroke 120ms linear, stroke-dashoffset 120ms linear;stroke-width:var(--ring-w);stroke-linecap:round}
  .ring-svg path{transition:stroke 120ms linear, stroke-dashoffset 120ms linear;stroke-linecap:round}
  button.big{width:var(--btn-size);height:var(--btn-size);border:none;font-size:30px;font-weight:800;color:#fff;background:linear-gradient(180deg,var(--accent-a),var(--accent-b));box-shadow:0 22px 40px rgba(2,6,23,0.6), 0 6px 18px rgba(0,0,0,0.6), inset 0 4px 14px rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;transition:transform 140ms, box-shadow 140ms; clip-path: polygon(50% 0%, 100% 86.6%, 0% 86.6%);}
  button.big:active{transform:translateY(4px) scale(.99);box-shadow:0 10px 18px rgba(0,0,0,0.5), inset 0 2px 8px rgba(255,255,255,0.02)}
  button.big.disabled{opacity:.78;pointer-events:none}

  /* Instruction */
  .instruction{width:100%;text-align:center;font-weight:800;font-size:28px;color:#fff;margin-top:8px;margin-bottom:6px;display:flex;align-items:center;justify-content:center;gap:8px}
  .instruction .exercise{color:#ffdca3;font-weight:900;font-size:28px}
  .fade{animation:fadeIn 320ms ease}
  @keyframes fadeIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:none}}

  /* Digital */
  .digital{width:calc(100% - 24px);margin:12px auto 0;padding:10px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.04));border:1px solid var(--outline);text-align:center}
  .digital .time{font-size:20px;font-weight:800}
  .subtitle{font-size:12px;color:var(--muted);margin-top:4px}
  .subrow{display:flex;gap:8px;align-items:stretch;justify-content:center;margin-top:10px}
  .small-box{flex:1;min-width:0;padding:8px 10px;border-radius:10px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02);text-align:center;display:flex;flex-direction:column;align-items:center;justify-content:center;aspect-ratio:3/2}
  .small-title{font-size:15.6px;color:var(--muted);margin-bottom:4px}
  .small-val{font-weight:800;font-size:15px}
  .small-sub{font-size:11px;color:var(--muted);margin-top:4px}
  #totalLabel{display:none}
  .step{ text-align:center;color:var(--muted);font-size:13px;margin-top:8px }

  .actions{display:flex;flex-direction:column;gap:10px;align-items:center;justify-content:center;margin-top:10px}
  .btn{padding:8px 12px;border-radius:10px;border:none;font-weight:700;cursor:pointer}
  .btn.secondary{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.06)}
  .btn.primary{background:linear-gradient(180deg,var(--accent-a),var(--accent-b));color:#fff;border:1px solid rgba(255,255,255,0.06)}

  /* Larger Auto button */
  #autoBtn{ font-size: 1.5em; padding: 12px 18px; }
  /* Reset button text light red */
  #resetBtn{ color: #ff9aa2; font-weight:800; padding:8px 16px; transform: scaleX(1.3); transform-origin: center; }

  /* Rest label styling */
  .resting-label{ text-transform: uppercase; font-size: 18px; animation: blink 1000ms step-start infinite; }
  @keyframes blink { 0%, 49% { opacity: 1; } 50%, 100% { opacity: 0.2; } }
  /* Idle (invisible) rest label state */
  .idle-rest{ color: var(--bg-2) !important; animation: none !important; }

  /* Big button blink for reps */
  @keyframes bigBlink { 0%{filter:brightness(1)} 50%{filter:brightness(1.6)} 100%{filter:brightness(1)} }
  .big.blink{ animation: bigBlink 600ms ease-in-out; }

  /* Screen flash synchronized with blink */
  #screenFlash{ position:fixed; inset:0; pointer-events:none; z-index:1; opacity:0; background:rgba(255,80,80,0.0); }
  .screen-flash{ animation: screenBlink 600ms ease-in-out; }
  @keyframes screenBlink { 0%{ opacity:0; background:rgba(255,80,80,0.0); } 50%{ opacity:1; background:rgba(255,80,80,0.18); } 100%{ opacity:0; background:rgba(255,80,80,0.0); } }

  /* overlays */
  .overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:60;color:#fff;padding:20px;box-sizing:border-box;overflow:auto}
  .panel{background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));padding:16px;border-radius:12px;max-width:720px;margin:20px auto;border:1px solid var(--outline)}
  .confirm-panel{max-width:520px;margin:80px auto;padding:18px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));border:1px solid var(--outline);text-align:center}
  .confirm-actions{display:flex;gap:10px;justify-content:center;margin-top:12px}

  /* done pulse */
  @keyframes donePulse {
    0% { box-shadow: 0 22px 40px rgba(2,6,23,0.6), 0 6px 18px rgba(0,0,0,0.6), 0 0 0 0 rgba(255,255,255,0.04); transform: translateY(0); }
    50% { box-shadow: 0 30px 50px rgba(2,6,23,0.65), 0 10px 24px rgba(0,0,0,0.6), 0 0 12px 8px rgba(42,160,255,0.12); transform: translateY(-2px); }
    100% { box-shadow: 0 22px 40px rgba(2,6,23,0.6), 0 6px 18px rgba(0,0,0,0.6), 0 0 0 0 rgba(255,255,255,0.04); transform: translateY(0); }
  }
  .done-pulse{animation:donePulse 1600ms ease-in-out infinite;}

  @media (max-width:420px){
    :root{--card-w:94vw}
    .instruction{font-size:22px}
    button.big{width:calc(var(--btn-size) * 1.15);height:calc(var(--btn-size) * 1.15);font-size:34px}
    .btn-area{width:calc(var(--btn-size) + 160px);height:calc(var(--btn-size) + 160px)}
    .ring-svg{width:calc(var(--btn-size) + 160px);height:calc(var(--btn-size) + 160px)}
    #maxInput{ width:66px; }
  }

  .ripple{position:absolute;border-radius:50%;transform:translate(-50%,-50%) scale(0);background:rgba(255,255,255,0.10);pointer-events:none;animation:ripple 700ms ease-out;}
  @keyframes ripple{to{transform:translate(-50%,-50%) scale(3.2);opacity:0}}
</style>
</head>
<body>
  <div id="screenFlash" aria-hidden="true"></div>
  <div class="center">
    <div class="card" role="application" aria-label="Pyramid Counter">

      <!-- TOP BAR -->
      <div class="topbar">
        <div class="icons-left">
          <div id="settingsIcon" class="icon" title="Settings" aria-label="Settings">‚öôÔ∏è</div>
          <div id="userIcon" class="icon" title="User" aria-label="User">üë§</div>
          <div id="helpIcon" class="icon" title="Help" aria-label="Help">?</div>
        </div>
        <div class="icons-center">
          <div id="trophyIcon" class="icon" title="Achievements" aria-label="Achievements">üèÜ</div>
        </div>
        <div class="icons-right">
          <div id="speakerIcon" class="icon" title="Sound" aria-label="Sound">üîä</div>
        </div>
      </div>

      <!-- USER POPUP -->
      <div id="userPopup" class="overlay" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="panel" style="max-width:520px">
          <h2>User Profile</h2>
          <div style="display:flex;flex-direction:column;gap:12px">
            <div>
              <strong>Sex</strong><br>
              <select id="userSex">
                <option value="male">Male</option>
                <option value="female">Female</option>
              </select>
            </div>
            <div>
              <strong>Age</strong><br>
              <input id="userAge" type="number" inputmode="decimal" min="5" max="120" placeholder="e.g. 30" />
            </div>
            <div>
              <strong>Height (cm)</strong><br>
              <input id="userHeightCm" type="number" inputmode="decimal" min="50" max="250" placeholder="e.g. 175" />
            </div>
            <div>
              <strong>Weight (kg)</strong><br>
              <input id="userWeightKg" type="number" inputmode="decimal" min="20" max="300" placeholder="e.g. 70" />
            </div>
            <div style="display:flex;gap:10px;justify-content:flex-end">
              <button id="closeUser" class="btn secondary">Close</button>
              <button id="saveUser" class="btn primary">Save</button>
            </div>
          </div>
        </div>
      </div>
      <!-- INPUTS -->
      <div class="inputs-row">
        <div class="input-col">
          <div class="input-label">Max rep</div>
          <input id="maxInput" type="number" inputmode="numeric" min="1" max="99" value="5" aria-label="Maximum pyramid number" />
        </div>
        <div class="input-col">
          <div class="input-label">Exercise type</div>
          <select id="modeSelect" aria-label="Mode">
            <option value="squats">Squats</option>
            <option value="pushups">Push-ups</option>
            <option value="pullups">Pull-ups</option>
            <option value="situps">Sit-ups</option>
            <option value="burpees">Burpees</option>
          </select>
        </div>
      </div>

      <!-- INSTRUCTION -->
      <div class="instruction" id="instructionText" aria-live="polite">
        <span class="verb">Complete</span>
        <span class="count" id="instrCount">-</span>
        <span class="exercise" id="instrExercise">-</span>
      </div>

      <!-- MAIN -->
      <div class="main" role="region" aria-label="Counter area">
        <div class="btn-area">
          <svg id="halo" class="ring-svg" viewBox="0 0 200 200" aria-hidden="true">
            <defs>
              <linearGradient id="rg" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#00ff7f"/>
                <stop offset="55%" stop-color="#ffd400"/>
                <stop offset="100%" stop-color="#ff3b3b"/>
              </linearGradient>
            </defs>
            <!-- Equilateral triangle around the button -->
            <path id="baseRing" d="M100 20 L180 160 L20 160 Z" fill="none" stroke="rgba(255,255,255,0.03)" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
            <path id="prog" d="M100 20 L180 160 L20 160 Z" fill="none" stroke="url(#rg)" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
          </svg>

          <button id="bigBtn" class="big" aria-label="Advance pyramid">Start</button>
          <div id="rippleContainer" aria-hidden="true"></div>
        </div>
      </div>

      <div class="step" id="stepText">Step 0 of 0</div>

      <div class="actions">
        <button id="autoBtn" class="btn secondary">Auto</button>
        <button id="resetBtn" class="btn secondary">Reset</button>
      </div>

      <div class="digital" id="digitalClock" aria-live="polite">
        <div class="subtitle idle-rest" id="countdownLabel">PLEASE REST FOR</div>
        <div class="time" id="countdown">00:00</div>

        <div class="subrow">
          <div class="small-box">
            <div class="small-title">Level</div>
            <div class="small-val" id="levelDisplay">Beginner</div>
          </div>
          <div class="small-box">
            <div class="small-title">Elapsed</div>
            <div class="small-val" id="elapsedDisplay">00:00</div>
          </div>
          <div class="small-box">
            <div class="small-title">Total</div>
            <div class="small-val" id="totalRepsDisplay">0</div>
            <div class="small-sub" id="totalLabel">squats performed</div>
          </div>
        </div>
      </div>

      <!-- HELP POPUP -->
      <div id="helpPopup" class="overlay" role="dialog" aria-modal="true">
        <div class="panel" style="max-height:72vh; overflow:auto">
          <h2>Help</h2>
          <details>
            <summary style="font-weight:800; cursor:pointer">What is Pyramid Workout Counter</summary>
            <div style="margin-top:8px">
              <p>This app guides you through a ‚Äúpyramid‚Äù workout. You do 1 rep, then 2, then 3, up to your chosen maximum, and then back down again (for example: 1, 2, 3, 2, 1). It keeps time, counts your total reps, and shows your progress with a circle and a simple step counter.</p>
            </div>
          </details>

          <details>
            <summary style="font-weight:800; cursor:pointer">How it works / How to use it</summary>
            <div style="margin-top:8px">
              <ul>
                <li><strong>Pick your max number</strong> in the top inputs (for example 10). That sets how high the pyramid goes.</li>
                <li><strong>Choose your exercise</strong> (for example squats or push-ups). You can also enter a custom name.</li>
                <li><strong>Manual mode</strong>: Tap the big button to start. Do the reps shown. Tap again when you finish that set. The app advances the pyramid and adds to your total.</li>
                <li><strong>Auto mode</strong>: Press Auto and the app runs each step with a countdown (exercise + rest) until the whole pyramid is done.</li>
                <li><strong>Settings</strong>: Set your level (this adjusts timing), seconds per rep, and rest time. You can also mute/unmute sounds with the speaker icon.</li>
                <li><strong>Reset</strong>: Use Reset if you want to clear the session (elapsed time and totals).</li>
                <li><strong>Achievements</strong>: After finishing, save your session, view past sessions, or download them as a CSV file.</li>
              </ul>
            </div>
          </details>

          <details>
            <summary style="font-weight:800; cursor:pointer">Why do pyramid workouts</summary>
            <div style="margin-top:8px">
              <p>Pyramid sets are popular because they‚Äôre simple and effective:</p>
              <ul>
                <li><strong>Built‚Äëin warm up and cool down</strong>: You start with smaller sets, build up, then taper down‚Äîthis eases your body in and out.</li>
                <li><strong>Progressive challenge</strong>: Climbing to a peak set pushes your strength and endurance without jumping straight to the hardest work.</li>
                <li><strong>Variety and motivation</strong>: Changing reps each set keeps things interesting and helps avoid plateaus.</li>
                <li><strong>Time‚Äëefficient</strong>: You get a clear plan with a fixed number of total reps, which fits easily into a short session.</li>
                <li><strong>Scalable</strong>: You can adjust the max number, pace, and rest to match your level and exercise.</li>
              </ul>
            </div>
          </details>

          <div style="text-align:right;margin-top:12px"><button id="closeHelp" class="btn primary">Close</button></div>
        </div>
      </div>

      <!-- SETTINGS POPUP -->
      <div id="settingsPopup" class="overlay" role="dialog" aria-modal="true">
        <div class="panel">
          <h2>Settings</h2>
          <div style="display:flex;flex-direction:column;gap:12px">
            <div>
              <strong>User level</strong><br>
              <label><input type="radio" name="level" value="athlete"> Athlete</label><br>
              <label><input type="radio" name="level" value="intermediate"> Intermediate</label><br>
              <label><input type="radio" name="level" value="low"> Low</label><br>
              <label><input type="radio" name="level" value="beginner" checked> Beginner</label>
            </div>

            <div>
              <strong>Custom seconds-per-rep</strong><br>
              <input id="customSecondsPerRep" type="number" inputmode="decimal" min="0.1" step="0.1" placeholder="seconds per rep"/>
            </div>

            <div>
              <strong>Rest seconds per rep</strong><br>
              <input id="restPerRepSec" type="number" inputmode="decimal" min="1" step="0.5" value="10"/>
            </div>

            

            <div style="text-align:right"><button id="closeSettings" class="btn primary">Close</button></div>
          </div>
        </div>
      </div>

      <!-- RESET CONFIRM -->
      <div id="resetConfirm" class="overlay" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="confirm-panel">
          <h3>Confirm reset</h3>
          <p>This will clear the current pyramid (elapsed time and total reps). Are you sure?</p>
          <div class="confirm-actions">
            <button id="cancelReset" class="btn secondary">Cancel</button>
            <button id="confirmReset" class="btn primary">Confirm Reset</button>
          </div>
        </div>
      </div>

      <!-- SUMMARY (appears after completion) -->
      <div id="summaryPopup" class="overlay" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="panel" id="summaryPanel" style="max-width:420px">
          <h2>Workout Summary</h2>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
            <div><div style="color:var(--muted);font-size:12px">Pyramid</div><div id="summaryMax" style="font-weight:800;font-size:16px">-</div></div>
            <div><div style="color:var(--muted);font-size:12px">Total reps</div><div id="summaryTotal" style="font-weight:800;font-size:16px">-</div></div>
            <div><div style="color:var(--muted);font-size:12px">Elapsed</div><div id="summaryElapsed" style="font-weight:800;font-size:16px">-</div></div>
            <div><div style="color:var(--muted);font-size:12px">Calories</div><div id="summaryCalories" style="font-weight:800;font-size:16px">-</div></div>
          </div>
          <div style="margin-top:12px;color:var(--muted);font-size:13px" id="summaryDate">-</div>
          <div style="text-align:right;margin-top:14px">
            <button id="saveAchievementBtn" class="btn primary">Save to Achievements</button>
            <button id="closeSummaryBtn" class="btn secondary">Close</button>
          </div>
        </div>
      </div>

      <!-- ACHIEVEMENTS -->
      <div id="achPopup" class="overlay" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="panel" style="max-width:720px">
          <h2>Achievements</h2>
          <div id="achList" style="margin-top:8px"></div>
          <div style="display:flex;gap:8px;justify-content:space-between;align-items:center;margin-top:12px">
            <div style="color:var(--muted);font-size:13px">Saved sessions are stored locally on this device.</div>
            <div>
              <button id="downloadCsv" class="btn secondary">Download CSV</button>
              <button id="closeAch" class="btn primary">Close</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
(function(){
  // Elements
  const maxInput = document.getElementById('maxInput');
  const modeSelect = document.getElementById('modeSelect');
  const bigBtn = document.getElementById('bigBtn');
  const prog = document.getElementById('prog');
  let TRI_LEN = 0;
  const instrCount = document.getElementById('instrCount');
  const instrExercise = document.getElementById('instrExercise');
  const instructionText = document.getElementById('instructionText');
  const countdownEl = document.getElementById('countdown');
  const stepText = document.getElementById('stepText');
  const resetBtn = document.getElementById('resetBtn');
  const autoBtn = document.getElementById('autoBtn');
  const screenFlash = document.getElementById('screenFlash');

  const trophyIcon = document.getElementById('trophyIcon');
  const settingsIcon = document.getElementById('settingsIcon');
  const helpIcon = document.getElementById('helpIcon');
  const speakerIcon = document.getElementById('speakerIcon');
  const userIcon = document.getElementById('userIcon');

  const helpPopup = document.getElementById('helpPopup');
  const closeHelp = document.getElementById('closeHelp');
  const settingsPopup = document.getElementById('settingsPopup');
  const closeSettings = document.getElementById('closeSettings');

  const customSecondsPerRepInput = document.getElementById('customSecondsPerRep');
  const restPerRepSecInput = document.getElementById('restPerRepSec');
  const levelRadios = document.querySelectorAll('input[name="level"]');

  const levelDisplay = document.getElementById('levelDisplay');
  const elapsedDisplay = document.getElementById('elapsedDisplay');
  const totalRepsDisplay = document.getElementById('totalRepsDisplay');
  const totalLabel = document.getElementById('totalLabel');
  const countdownLabel = document.getElementById('countdownLabel');

  const resetConfirm = document.getElementById('resetConfirm');
  const confirmReset = document.getElementById('confirmReset');
  const cancelReset = document.getElementById('cancelReset');

  const summaryPopup = document.getElementById('summaryPopup');
  const summaryMax = document.getElementById('summaryMax');
  const summaryTotal = document.getElementById('summaryTotal');
  const summaryElapsed = document.getElementById('summaryElapsed');
  const summaryCalories = document.getElementById('summaryCalories');
  const summaryDate = document.getElementById('summaryDate');
  const saveAchievementBtn = document.getElementById('saveAchievementBtn');
  const closeSummaryBtn = document.getElementById('closeSummaryBtn');

  const achPopup = document.getElementById('achPopup');
  const achList = document.getElementById('achList');
  const downloadCsv = document.getElementById('downloadCsv');
  const closeAch = document.getElementById('closeAch');

  // User modal elements
  const userPopup = document.getElementById('userPopup');
  const userSexSelect = document.getElementById('userSex');
  const userAgeInput = document.getElementById('userAge');
  const userHeightCmInput = document.getElementById('userHeightCm');
  const userWeightKgInput = document.getElementById('userWeightKg');
  const saveUserBtn = document.getElementById('saveUser');
  const closeUserBtn = document.getElementById('closeUser');

  // SFX
  const MUTE_KEY = 'pyr_sfx_mute_v1';
  const sfx = {
    click: new Audio('SFX/click-button.mp3'),
    help: new Audio('SFX/help-button.mp3'),
    stepStart: new Audio('SFX/step-start.mp3'),
    stepComplete: new Audio('SFX/step-complete.mp3'),
    finish: new Audio('SFX/finish-jingle.mp3'),
    repetition: new Audio('SFX/repetition.mp3'),
    auto: new Audio('SFX/auto.mp3'),
    reset: new Audio('SFX/reset.mp3'),
    save: new Audio('SFX/save.mp3'),
    error: new Audio('SFX/error.mp3')
  };
  Object.values(sfx).forEach(a=>{ a.preload='auto'; });
  let sfxMuted = false;
  function setMutedAll(m){ Object.values(sfx).forEach(a=> a.muted = m); }
  function updateSpeakerIcon(){ speakerIcon.textContent = sfxMuted ? 'üîá' : 'üîä'; }
  function loadMute(){ sfxMuted = (localStorage.getItem(MUTE_KEY) === '1'); setMutedAll(sfxMuted); updateSpeakerIcon(); }
  function saveMute(){ localStorage.setItem(MUTE_KEY, sfxMuted ? '1' : '0'); }
  function play(name){ const a = sfx[name]; if(!a) return; try{ a.currentTime = 0; a.play(); }catch(e){} }

  // State
  let max = Math.max(1, parseInt(maxInput.value) || 5);
  let current = 0;
  let dir = 1;
  let autoRunning = false;
  let autoPaused = false;
  let autoPhase = null; // 'exercise' | 'rest'
  let autoSeq = [];
  let autoIdx = 0;
  let exerciseTimer = null;
  let restTimer = null; // interval for rest countdown
  let exRemainingMs = 0;
  let restRemainingMs = 0;
  let tickTimer = null;
  let userLevel = 'beginner';
  let manualTimer = null;
  let manualStart = 0;
  let manualElapsedSec = 0;
  let manualFinished = false;
  let manualRestTimer = null;
  let manualRestRemainingMs = 0;
  let manualAwaitNext = false;

  let overallTimer = null;
  let overallStart = 0;
  let overallElapsedSec = 0;

  let totalReps = 0;

  // achievements storage key
  const ACH_KEY = 'pyr_achievements_v1';
  const STATE_KEY = 'pyr_state_v1';

  // Ring maths
  // compute triangular path length for progress
  TRI_LEN = (typeof prog.getTotalLength === 'function') ? prog.getTotalLength() : 452;
  prog.style.strokeDasharray = TRI_LEN;
  prog.style.strokeDashoffset = TRI_LEN;

  // helpers
  function fmtSecondsMMSS(s){ s = Math.max(0, Math.round(s)); const m = Math.floor(s/60); const sec = s%60; return String(m).padStart(2,'0')+':'+String(sec).padStart(2,'0'); }
  function colorFor(val,maxv){ if (maxv<=1) return 'hsl(120,100%,50%)'; const ratio = Math.max(0,Math.min(1,val/maxv)); const hue = 120 - (120*ratio); return `hsl(${hue},100%,45%)`; }
  function currentExerciseName(){ const opt = modeSelect.options[modeSelect.selectedIndex]; return opt ? opt.text.toLowerCase() : (modeSelect.value||'exercise'); }
  function pluralExerciseLabel(){ const ex = currentExerciseName(); const low = ex.toLowerCase(); if (low.endsWith('s')) return low + ' performed'; return low + 's performed'; }

  function stepOrdinal(){
    if (current===0) return 0;
    if (dir===1) return current;
    return max + (max - current);
  }

  // persistence
  function loadState(){ try{ const s = JSON.parse(localStorage.getItem(STATE_KEY) || '{}'); if(typeof s.current === 'number'){ current = s.current; dir = s.dir || 1; } if(s.userLevel) userLevel = s.userLevel; if(s.customSecondsPerRep) customSecondsPerRepInput.value = s.customSecondsPerRep; if(s.restPerRepSec) restPerRepSecInput.value = s.restPerRepSec; if(s.user){ userSexSelect.value = s.user.sex||'male'; userAgeInput.value = s.user.age||''; userHeightCmInput.value = s.user.heightCm||''; userWeightKgInput.value = s.user.weightKg||''; applyAccentByGender(userSexSelect.value); } levelRadios.forEach(r=>{ if(r.value===userLevel) r.checked=true; }); }catch(e){} updateLevelDisplay(); }
  function saveState(){ const s = { current, dir, userLevel, customSecondsPerRep: customSecondsPerRepInput.value, restPerRepSec: restPerRepSecInput.value, user: { sex: userSexSelect.value||'', age: userAgeInput.value||'', heightCm: userHeightCmInput.value||'', weightKg: userWeightKgInput.value||'' } }; try{ localStorage.setItem(STATE_KEY, JSON.stringify(s)); } catch(e) {} }

  function loadAchievements(){ try{ const raw = localStorage.getItem(ACH_KEY); return raw ? JSON.parse(raw) : []; }catch(e){return [];} }
  function saveAchievements(arr){ try{ localStorage.setItem(ACH_KEY, JSON.stringify(arr)); }catch(e){} }

  // timing formulas
  function baseSecondsPerRepForMode(){ const m = modeSelect.value; if(m==='squats') return 3.0; if(m==='pushups') return 2.0; if(m==='pullups') return 2.5; if(m==='situps') return 2.5; if(m==='burpees') return 3.0; if(m==='custom'){ const v=parseFloat(customSecondsPerRepInput.value); return (isFinite(v)&&v>0)?v:2.0 } return 2.0; }
  function levelMultiplier(){ switch(userLevel){ case 'athlete':return .75; case 'intermediate':return 1; case 'low':return 1.2; case 'beginner':return 1.45; default:return 1; } }
  function exerciseSecondsForNumber(n){ return baseSecondsPerRepForMode() * levelMultiplier() * n; }
  function restSecondsForNumber(n){ const rUnit = parseFloat(restPerRepSecInput.value); const r = (isFinite(rUnit)&&rUnit>0)?rUnit:10; const lvl = (userLevel==='athlete')?0.8:(userLevel==='beginner')?1.4:(userLevel==='low')?1.2:1.0; return r*lvl*n; }

  // basic calorie estimate
  // Use approximate MET values per exercise type:
  const METS = {
    'squats': 5,
    'pushups': 8,
    'pullups': 7,
    'situps': 6,
    'burpees': 10,
    'exercise': 6
  };
  // default weight (kg) used for estimate; you may add weight setting later
  const DEFAULT_WEIGHT_KG = 70;

  function estimateCalories(totalSeconds){
    const ex = modeSelect.value || 'exercise';
    const met = METS[ex] || METS['exercise'];
    const hours = totalSeconds / 3600;
    const calories = met * DEFAULT_WEIGHT_KG * hours;
    return Math.round(calories);
  }

  // UI updates
  function showInstruction(n){ instrCount.textContent = n===0?'-':n; instrExercise.textContent = n===0?'-':currentExerciseName(); instructionText.classList.remove('fade'); void instructionText.offsetWidth; instructionText.classList.add('fade'); }
  function updateTotalDisplay(){ totalRepsDisplay.textContent = String(totalReps); }
  function updateLevelDisplay(){ levelDisplay.textContent = userLevel.charAt(0).toUpperCase() + userLevel.slice(1); }

  function updateUI(){
    showInstruction(current);
    stepText.textContent = `Step ${stepOrdinal()} of ${max*2-1}`;
    if(!autoRunning){
      const pct = Math.max(0, Math.min(1, (current / Math.max(1, max))));
      prog.style.strokeDashoffset = TRI_LEN * (1 - pct);
      prog.style.stroke = colorFor(current, max);
      if(!manualTimer) countdownEl.textContent = '00:00';
      countdownLabel.textContent = 'PLEASE REST FOR';
      const resting = manualRestRemainingMs>0;
      countdownLabel.classList.toggle('resting-label', resting);
      countdownLabel.classList.toggle('idle-rest', !resting);
      bigBtn.classList.remove('disabled');
      bigBtn.textContent = current===0? 'Start' : String(current);
    } else {
      bigBtn.classList.add('disabled');
      bigBtn.textContent = current===0? '‚Äî' : String(current);
    }
    saveState();
    updateLevelDisplay();
    updateTotalDisplay();
    // toggle auto button visual state
    if(autoRunning || autoPaused){ autoBtn.classList.add('primary'); autoBtn.classList.remove('secondary'); }
    else { autoBtn.classList.remove('primary'); autoBtn.classList.add('secondary'); }
  }

  // overall elapsed timer
  function startOverallTimer(offsetSec=0){ stopOverallTimer(); overallStart = performance.now() - offsetSec*1000; overallElapsedSec = offsetSec; elapsedDisplay.textContent = fmtSecondsMMSS(offsetSec); overallTimer = setInterval(()=>{ const s = Math.floor((performance.now() - overallStart)/1000); if (s !== overallElapsedSec){ overallElapsedSec = s; elapsedDisplay.textContent = fmtSecondsMMSS(overallElapsedSec); } }, 300); }
  function stopOverallTimer(){ if (overallTimer){ clearInterval(overallTimer); overallTimer=null; } }
  function resetOverallTimer(){ stopOverallTimer(); overallElapsedSec = 0; elapsedDisplay.textContent = fmtSecondsMMSS(0); }

  // manual stopwatch
  function startManualStopwatch(){ stopManualStopwatch(); manualStart = performance.now(); manualElapsedSec = 0; countdownEl.textContent = fmtSecondsMMSS(0); countdownLabel.textContent = ''; countdownLabel.classList.remove('resting-label'); manualTimer = setInterval(()=>{ const elapsedMs = performance.now()-manualStart; const elapsedSec = Math.floor(elapsedMs/1000); if(elapsedSec !== manualElapsedSec){ manualElapsedSec = elapsedSec; countdownEl.textContent = fmtSecondsMMSS(manualElapsedSec); } },200); }
  function stopManualStopwatch(){ if(manualTimer){ clearInterval(manualTimer); manualTimer=null; } }
  function startManualRest(n){ if(manualRestTimer){ clearInterval(manualRestTimer); manualRestTimer=null; } manualRestRemainingMs = Math.max(300, Math.round(restSecondsForNumber(n)*1000)); countdownLabel.textContent = 'PLEASE REST FOR'; countdownLabel.classList.add('resting-label'); countdownLabel.classList.remove('idle-rest'); function tick(){ manualRestRemainingMs = Math.max(0, manualRestRemainingMs-200); countdownEl.textContent = fmtSecondsMMSS(Math.ceil(manualRestRemainingMs/1000)); if(manualRestRemainingMs>0){ manualRestTimer = setTimeout(tick,200); } else { countdownLabel.classList.remove('resting-label'); countdownLabel.classList.add('idle-rest'); manualAwaitNext = true; } } tick(); }

  // manual flow
  // Manual mirroring auto with skippable rest/blink
  function manualAdvance_StartOrNext(){
    if(manualFinished) return;
    // start manual flow
    if(current===0){ current=1; dir=1; if(!overallTimer) startOverallTimer(); updateUI(); manualBeginExercisePhase(); return; }
    // if currently resting, skip to next step immediately
    if(manualRestRemainingMs>0){ if(manualRestTimer){ clearTimeout(manualRestTimer); manualRestTimer=null; } manualRestRemainingMs = 0; countdownLabel.textContent=''; countdownLabel.classList.remove('resting-label'); countdownLabel.classList.add('idle-rest'); manualAwaitNext = true; }
    // if awaiting next step after rest, start the next step now
    if(manualAwaitNext){ manualAwaitNext = false; advanceToNextStep(); return; }
    // if blinking is active in manual, skip to next step and count the set
    if(blinkActive && blinkContext==='manual'){ stopBlinking(); totalReps += current; updateTotalDisplay(); startManualRest(current); return; }
    // otherwise, complete current set and go to rest
    totalReps += current; updateTotalDisplay(); startManualRest(current);
  }

  function finishManual(){
    stopManualStopwatch();
    manualFinished=true;
    stopOverallTimer();
    bigBtn.textContent='Done';
    current=1; dir=1;
    bigBtn.classList.add('done-pulse');
    // show summary popup with final numbers
    play('finish');
    setTimeout(()=>{ showSummary(); }, 2000);
    updateUI();
  }

  // build 1..max..1 sequence
  function buildPyramidSequence(maxN){ const seq=[]; for(let i=1;i<=maxN;i++) seq.push(i); for(let j=maxN-1;j>=1;j--) seq.push(j); return seq; }

  // auto run with pause and rest countdown
  function startAuto(){
    stopManualStopwatch();
    manualFinished=false;
    if(current===0) current=1;
    if(!overallTimer) startOverallTimer();
    autoRunning=true; autoPaused=false; autoBtn.textContent='Pause'; bigBtn.classList.add('disabled');
    autoSeq = buildPyramidSequence(max);
    autoIdx = autoSeq.indexOf(current);
    if(autoIdx < 0) autoIdx = 0;
    beginExercisePhase();
    updateUI();
  }

  function pauseAuto(){
    if(!autoRunning) return;
    autoPaused = true; autoRunning = false; autoBtn.textContent='Resume';
    if(exerciseTimer){ clearInterval(exerciseTimer); exerciseTimer=null; }
    if(restTimer){ clearInterval(restTimer); restTimer=null; }
    // Pause overall timer
    stopOverallTimer();
    updateUI();
  }

  function resumeAuto(){
    if(!autoPaused) return;
    autoRunning = true; autoPaused = false; autoBtn.textContent='Pause';
    startOverallTimer(overallElapsedSec);
    if(autoPhase === 'exercise') resumeExercisePhase();
    else if(autoPhase === 'rest') resumeRestPhase();
    updateUI();
  }

  function finishAuto(){
    autoRunning = false; autoPaused = false; autoBtn.textContent='Auto';
    if(exerciseTimer){ clearInterval(exerciseTimer); exerciseTimer=null; }
    if(restTimer){ clearInterval(restTimer); restTimer=null; }
    bigBtn.classList.remove('disabled');
    manualFinished = true;
    stopOverallTimer();
    bigBtn.textContent = 'Done';
    bigBtn.classList.add('done-pulse');
    countdownEl.textContent = '00:00';
    play('finish');
    setTimeout(()=>{ showSummary(); }, 2000);
    updateUI();
  }

  function beginExercisePhase(){
    autoPhase = 'exercise';
    const n = autoSeq[autoIdx];
    current = n; updateUI(); stepText.textContent = `Step ${autoIdx+1} of ${autoSeq.length}`; play('stepStart');
    // step-based ring (no within-step animation), just set color and offset
    const pct = Math.max(0, Math.min(1, (current / Math.max(1, max))));
    prog.style.strokeDashoffset = TRI_LEN * (1 - pct);
    prog.style.stroke = colorFor(n, max);
    // blink big button n times based on level interval, then rest
    blinkContext='auto'; blinkRepsThenRest(n);
    countdownLabel.textContent = 'PLEASE REST FOR';
    countdownLabel.classList.add('idle-rest');
    countdownLabel.classList.remove('resting-label');
  }

  function resumeExercisePhase(){
    // resume blinking sequence based on remaining blinks
    const n = autoSeq[autoIdx];
    continueBlinking();
  }

  function beginRestPhase(){
    autoPhase = 'rest';
    const n = autoSeq[autoIdx];
    const rest = Math.max(300, Math.round(restSecondsForNumber(n)*1000));
    restRemainingMs = rest;
    countdownLabel.textContent = 'PLEASE REST FOR';
    updateRestCountdown();
    function restTick(){
      if(!autoRunning){ return; }
      restRemainingMs = Math.max(0, restRemainingMs - 200);
      updateRestCountdown();
      if(restRemainingMs > 0){ restTimer = setTimeout(restTick, 200); }
      else { autoIdx++; if(autoIdx >= autoSeq.length){ finishAuto(); } else { beginExercisePhase(); } }
    }
    restTimer = setTimeout(restTick, 200);
    countdownLabel.classList.add('resting-label');
    countdownLabel.classList.remove('idle-rest');
  }

  function resumeRestPhase(){
    countdownLabel.textContent = 'PLEASE REST FOR';
    updateRestCountdown();
    function restTick(){
      if(!autoRunning){ return; }
      restRemainingMs = Math.max(0, restRemainingMs - 200);
      updateRestCountdown();
      if(restRemainingMs > 0){ restTimer = setTimeout(restTick, 200); }
      else { autoIdx++; if(autoIdx >= autoSeq.length){ finishAuto(); } else { beginExercisePhase(); } }
    }
    restTimer = setTimeout(restTick, 200);
    countdownLabel.classList.add('resting-label');
  }

  function updateRestCountdown(){
    const secs = Math.ceil(restRemainingMs/1000);
    countdownEl.textContent = fmtSecondsMMSS(secs);
  }

  // Blink logic for auto/manual exercise
  let blinkPlan = { total: 0, done: 0, interval: 1000 };
  let blinkContext = null; // 'auto' | 'manual'
  let blinkActive = false;
  function blinkIntervalForLevel(){ switch(userLevel){ case 'athlete': return 1500; case 'intermediate': return 1800; case 'low': return 2100; case 'beginner': return 2400; default: return 1800; } }
  function blinkOnce(){ bigBtn.classList.add('blink'); screenFlash.classList.add('screen-flash'); play('repetition'); setTimeout(()=>{ bigBtn.classList.remove('blink'); screenFlash.classList.remove('screen-flash'); }, Math.min(600, blinkPlan.interval*0.6)); }
  function stopBlinking(){ blinkActive=false; if(exerciseTimer){ clearTimeout(exerciseTimer); exerciseTimer=null; } }
  function scheduleNextBlink(){ if(!blinkActive) return; if(blinkPlan.done >= blinkPlan.total){ const n = (blinkContext==='auto')? autoSeq[autoIdx] : current; play('stepComplete'); if(blinkContext==='auto'){ totalReps += n; updateTotalDisplay(); beginRestPhase(); } else { totalReps += n; updateTotalDisplay(); startManualRest(n); } blinkActive=false; return; } const delay = (blinkPlan.done===0? 1000 : blinkPlan.interval); // 1s delay before first blink
    exerciseTimer = setTimeout(()=>{ if(!blinkActive) return; blinkOnce(); blinkPlan.done++; scheduleNextBlink(); }, delay); }
  function blinkRepsThenRest(n){ blinkPlan = { total: n, done: 0, interval: blinkIntervalForLevel() }; blinkActive=true; scheduleNextBlink(); }
  function continueBlinking(){ blinkActive=true; scheduleNextBlink(); }

  function manualBeginExercisePhase(){ const n = current; const pct = Math.max(0, Math.min(1, (n / Math.max(1, max)))); prog.style.strokeDashoffset = TRI_LEN * (1 - pct); prog.style.stroke = colorFor(n, max); blinkContext='manual'; play('stepStart'); countdownLabel.textContent='PLEASE REST FOR'; countdownLabel.classList.add('idle-rest'); countdownLabel.classList.remove('resting-label'); blinkRepsThenRest(n); }
  function advanceToNextStep(){ if(dir===1 && current<max){ current=current+1; updateUI(); manualBeginExercisePhase(); return; } if(dir===1 && current===max){ dir=-1; if(max>1){ current=current+dir; updateUI(); manualBeginExercisePhase(); return; } else { finishManual(); return; } } if(dir===-1 && current>1){ current=current+dir; updateUI(); manualBeginExercisePhase(); return; } if(dir===-1 && current===1){ finishManual(); return; } }

  // reset
  function doReset(){
    bigBtn.classList.remove('done-pulse');
    if(tickTimer){ clearTimeout(tickTimer); tickTimer=null; }
    if(exerciseTimer){ clearTimeout(exerciseTimer); exerciseTimer=null; }
    if(restTimer){ clearTimeout(restTimer); restTimer=null; }
    if(manualTimer){ clearInterval(manualTimer); manualTimer=null; }
    autoRunning=false; autoPaused=false; autoBtn.textContent='Auto'; current=0; dir=1; manualFinished=false; countdownEl.textContent='00:00';
    // reset max to default 5
    max = 5; maxInput.value = '5';
    prog.style.strokeDashoffset = TRI_LEN; bigBtn.classList.remove('disabled'); bigBtn.textContent='Start';
    stopOverallTimer(); resetOverallTimer();
    totalReps = 0; updateTotalDisplay(); updateUI();
  }

  // clamp input
  function clampMaxInput(){
    let v = parseInt(maxInput.value, 10);
    if (!isFinite(v) || v < 1) v = 1;
    if (v > 99) v = 99;
    max = v;
    maxInput.value = String(v);
    if (current > max) current = max;
    prog.style.strokeDashoffset = TRI_LEN * (1 - (current / Math.max(1, max)));
    updateUI();
  }

  // summary: prepare data and show dialog
  function showSummary(){
    const elapsed = overallElapsedSec || 0;
    const calories = estimateCalories(elapsed);
    const now = new Date();
    summaryMax.textContent = String(max);
    summaryTotal.textContent = String(totalReps);
    summaryElapsed.textContent = fmtSecondsMMSS(elapsed);
    summaryCalories.textContent = String(calories);
    summaryDate.textContent = now.toLocaleString();
    // store temporary last run in memory (for save)
    lastRun = {
      dateISO: now.toISOString(),
      dateDisplay: now.toLocaleString(),
      max: max,
      totalReps: totalReps,
      elapsedSec: elapsed,
      calories: calories,
      exercise: currentExerciseName()
    };
    summaryPopup.style.display = 'block';
    summaryPopup.setAttribute('aria-hidden','false');
  }

  // Save achievement
  let lastRun = null;
  function saveAchievement(){
    if(!lastRun) return;
    const arr = loadAchievements();
    arr.unshift(lastRun); // most recent first
    saveAchievements(arr);
    summaryPopup.style.display = 'none';
    summaryPopup.setAttribute('aria-hidden','true');
    // show achievements panel right away
    openAchievements();
    // auto reset for next workout
    doReset();
  }

  // Achievements UI
  function renderAchievements(){
    const arr = loadAchievements();
    if(arr.length===0){
      achList.innerHTML = '<div style="color:var(--muted)">No saved sessions yet. Finish a pyramid and save it to see it here.</div>';
      return;
    }
    const rows = arr.map((a, idx)=>{
      return `
        <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;padding:8px;border-bottom:1px solid rgba(255,255,255,0.02)">
          <div style="flex:1">
            <div style="font-weight:800">${a.exercise} ‚Ä¢ ${a.max}</div>
            <div style="font-size:13px;color:var(--muted)">${a.dateDisplay} ‚Ä¢ ${a.totalReps} reps ‚Ä¢ ${fmtSecondsMMSS(a.elapsedSec)} ‚Ä¢ ${a.calories} kcal</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button data-idx="${idx}" class="del-ach btn secondary">Delete</button>
          </div>
        </div>
      `;
    }).join('');
    achList.innerHTML = rows;

    // wire delete buttons
    document.querySelectorAll('.del-ach').forEach(btn=>{
      btn.addEventListener('click', (ev)=>{
        const idx = parseInt(btn.getAttribute('data-idx'),10);
        const arr = loadAchievements();
        arr.splice(idx,1);
        saveAchievements(arr);
        renderAchievements();
      });
    });
  }

  function openAchievements(){
    renderAchievements();
    achPopup.style.display = 'block';
    achPopup.setAttribute('aria-hidden','false');
  }

  // CSV export
  function downloadAchievementsCsv(){
    const arr = loadAchievements();
    if(!arr || arr.length===0) return alert('No achievements to download.');
    const header = ['dateISO','dateDisplay','exercise','max','totalReps','elapsedSec','calories'];
    const lines = [header.join(',')].concat(arr.map(a=>[
      `"${a.dateISO}"`,
      `"${(a.dateDisplay||'').replace(/"/g,'""')}"`,
      `"${(a.exercise||'').replace(/"/g,'""')}"`,
      a.max,
      a.totalReps,
      a.elapsedSec,
      a.calories
    ].join(',')));
    const csv = lines.join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'pyramid_achievements.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // events wiring
  bigBtn.addEventListener('pointerdown', (ev)=>{ ev.preventDefault(); const rc = document.getElementById('rippleContainer'); const r=document.createElement('div'); r.className='ripple'; const rect = ev.currentTarget.getBoundingClientRect(); const x=(ev.clientX-rect.left)||rect.width/2; const y=(ev.clientY-rect.top)||rect.height/2; r.style.left=x+'px'; r.style.top=y+'px'; r.style.width='16px'; r.style.height='16px'; rc.appendChild(r); r.addEventListener('animationend', ()=> r.remove()); if(autoRunning) return; if(manualFinished) return; play('click'); manualAdvance_StartOrNext(); });

  resetBtn.addEventListener('click', ()=>{ play('reset'); resetConfirm.style.display = 'block'; resetConfirm.setAttribute('aria-hidden','false'); });
  confirmReset.addEventListener('click', ()=>{ play('save'); resetConfirm.style.display='none'; resetConfirm.setAttribute('aria-hidden','true'); doReset(); });
  cancelReset.addEventListener('click', ()=>{ play('click'); resetConfirm.style.display='none'; resetConfirm.setAttribute('aria-hidden','true'); });

  autoBtn.addEventListener('click', ()=>{ play('auto');
    if(!autoRunning && !autoPaused){ startAuto(); }
    else if(autoRunning){ pauseAuto(); }
    else if(autoPaused){ resumeAuto(); }
  });

  trophyIcon.addEventListener('click', ()=>{ play('click'); openAchievements(); });
  closeAch.addEventListener('click', ()=>{ play('save'); achPopup.style.display='none'; achPopup.setAttribute('aria-hidden','true'); });

  settingsIcon.addEventListener('click', ()=>{ play('click'); settingsPopup.style.display='block'; settingsPopup.setAttribute('aria-hidden','false'); });
  closeSettings.addEventListener('click', ()=>{ play('save'); settingsPopup.style.display='none'; settingsPopup.setAttribute('aria-hidden','true'); });

  // user modal
  userIcon.addEventListener('click', ()=>{ play('click'); userPopup.style.display='block'; userPopup.setAttribute('aria-hidden','false'); });
  closeUserBtn.addEventListener('click', ()=>{ play('save'); userPopup.style.display='none'; userPopup.setAttribute('aria-hidden','true'); });
  function applyAccentByGender(g){
    const root = document.documentElement;
    if(g === 'female'){
      root.style.setProperty('--accent-a', '#8a2be2');
      root.style.setProperty('--accent-b', '#b266ff');
    } else {
      root.style.setProperty('--accent-a', '#0b84ff');
      root.style.setProperty('--accent-b', '#2aa0ff');
    }
  }
  function selectLevelRadio(level){ levelRadios.forEach(r=>{ r.checked = (r.value===level); }); }
  saveUserBtn.addEventListener('click', ()=>{
    play('click');
    const gender = userSexSelect.value;
    const hCm = parseFloat(userHeightCmInput.value);
    const wKg = parseFloat(userWeightKgInput.value);
    applyAccentByGender(gender);
    // simple BMI-based level suggestion
    if(isFinite(hCm) && hCm>0 && isFinite(wKg) && wKg>0){
      const hM = hCm/100;
      const bmi = wKg/(hM*hM);
      let lvl = 'intermediate';
      if(bmi < 21) lvl = 'athlete';
      else if(bmi < 25) lvl = 'intermediate';
      else if(bmi < 30) lvl = 'low';
      else lvl = 'beginner';
      userLevel = lvl;
      selectLevelRadio(lvl);
      updateLevelDisplay();
      saveState();
    }
    userPopup.style.display='none';
    userPopup.setAttribute('aria-hidden','true');
  });

  helpIcon.addEventListener('click', ()=>{ play('help'); helpPopup.style.display='block'; helpPopup.setAttribute('aria-hidden','false'); });
  closeHelp.addEventListener('click', ()=>{ play('save'); helpPopup.style.display='none'; helpPopup.setAttribute('aria-hidden','true'); });

  // speaker toggle
  speakerIcon.addEventListener('click', ()=>{
    sfxMuted = !sfxMuted;
    setMutedAll(sfxMuted);
    updateSpeakerIcon();
    saveMute();
  });

  saveAchievementBtn.addEventListener('click', ()=>{ play('save'); saveAchievement(); });
  closeSummaryBtn.addEventListener('click', ()=>{ play('save'); summaryPopup.style.display='none'; summaryPopup.setAttribute('aria-hidden','true'); doReset(); });

  downloadCsv.addEventListener('click', ()=>{ play('click'); downloadAchievementsCsv(); });

  // settings inputs
  levelRadios.forEach(r=> r.addEventListener('change', ()=>{ if(r.checked){ userLevel = r.value; updateLevelDisplay(); saveState(); } }));
  customSecondsPerRepInput.addEventListener('change', ()=> saveState());
  restPerRepSecInput.addEventListener('change', ()=> saveState());
  // clear on focus for quick entry
  customSecondsPerRepInput.addEventListener('focus', ()=> { customSecondsPerRepInput.value=''; });
  restPerRepSecInput.addEventListener('focus', ()=> { restPerRepSecInput.value=''; });
  // decimal-only sanitization (one dot max)
  customSecondsPerRepInput.addEventListener('input', ()=>{
    let v = customSecondsPerRepInput.value.replace(/[^0-9.]/g,'');
    const d = v.indexOf('.');
    if(d!==-1){ v = v.slice(0,d+1) + v.slice(d+1).replace(/\./g,''); }
    if(v.startsWith('.')) v = '0'+v;
    customSecondsPerRepInput.value = v;
  });
  restPerRepSecInput.addEventListener('input', ()=>{
    let v = restPerRepSecInput.value.replace(/[^0-9.]/g,'');
    const d = v.indexOf('.');
    if(d!==-1){ v = v.slice(0,d+1) + v.slice(d+1).replace(/\./g,''); }
    if(v.startsWith('.')) v = '0'+v;
    restPerRepSecInput.value = v;
  });
  
  modeSelect.addEventListener('change', ()=>{ updateUI(); saveState(); updateTotalDisplay(); });

  maxInput.addEventListener('change', clampMaxInput);
  maxInput.addEventListener('blur', clampMaxInput);
  maxInput.addEventListener('focus', ()=> { maxInput.value=''; });
  maxInput.addEventListener('input', ()=> {
    const v = maxInput.value.replace(/[^\d]/g, '').slice(0,2);
    maxInput.value = v === '' ? '' : String(parseInt(v,10));
  });

  // CSV download handler already above

  // init
  loadState();
  loadMute();
  resetBtn.textContent = 'R e s e t';
  clampMaxInput();
  totalReps = 0; updateTotalDisplay();
  updateUI();
  prog.style.stroke = colorFor(current, max);

})();
</script>
</body>
</html>